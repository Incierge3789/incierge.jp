---
// src/pages/contact/index.astro
import Base from "../../layouts/Base.astro";
const title = "Contact｜INCIERGE";
const desc =
  "ご相談フォーム。GPTでの事前相談メモがあれば自動入力されます。?prefill= もしくは ?gpts= で取り込み。";
---
<Base title={title} description={desc}>
  <h1>Contact</h1>
  <p>
    以下のフォームにご記入ください。<br />
    GPTの事前相談メモは <code>?prefill=</code> または <code>?gpts=</code> で自動入力されます。
  </p>

  <form method="POST" action="/api/contact" class="mt-6 space-y-4">
    <label class="block">
      <span>お名前（必須）</span>
      <input name="name" required class="w-full border rounded px-3 py-2" />
    </label>

    <label class="block">
      <span>メール（必須）</span>
      <input
        type="email"
        name="email"
        required
        class="w-full border rounded px-3 py-2"
      />
    </label>

    <label class="block">
      <span>会社名（任意）</span>
      <input name="company" class="w-full border rounded px-3 py-2" />
    </label>

    <label class="block">
      <span>HP（任意）</span>
      <input name="website" class="w-full border rounded px-3 py-2" />
    </label>

    <label class="block">
      <span>ご相談内容（必須）</span>
      <textarea
        id="message"
        name="message"
        rows="10"
        required
        class="w-full border rounded px-3 py-2"
      ></textarea>
    </label>

    {/* ▼ 任意：今すぐ日程を予約するブロック */}
    <div class="mt-4 rounded border px-4 py-3 text-sm bg-slate-50">
      <p class="mb-1 text-xs font-semibold text-slate-600">
        任意：今すぐ日程を予約する
      </p>
      <p class="mb-3 leading-relaxed">
        フォーム送信だけでも大丈夫です。すぐに日程まで決めたい方は、
        下のボタンからオンライン面談の候補日時をお選びいただけます。
      </p>
      <a
        href="/meeting?source=contact_optional"
        class="btn-primary inline-block text-sm"
      >
        日程を選ぶ（オンライン面談）
      </a>
    </div>

    <div class="cf-turnstile" data-sitekey="0x4AAAAAAB9qMJ4SG87lHVc2"></div>

    <button type="submit" class="btn-primary">送信</button>
  </form>

  <script>
    (function () {
      var el = document.getElementById("message");
      if (!el) return;

      var p = new URLSearchParams(location.search);

      // ① GPTs / prefill / automation からの生データ
      var gptsRaw = p.get("gpts");
      var prefillRaw = p.get("prefill");
      var qRaw = p.get("q"); // /automation からの一言メモ

      var text = "";

      // ② 優先順位: gpts > prefill > q
      if (gptsRaw) {
        try {
          text = atob(decodeURIComponent(gptsRaw));
        } catch (e) {
          text = "";
        }
      } else if (prefillRaw) {
        try {
          text = decodeURIComponent(prefillRaw);
        } catch (e) {
          text = "";
        }
      } else if (qRaw) {
        try {
          text = decodeURIComponent(qRaw);
        } catch (e) {
          text = "";
        }
      }

      if (text) {
        el.value = text;
        var n = document.createElement("div");
        n.textContent =
          "AI相談メモ／事前メモを読み込みました。必要に応じて追記・修正してください。";
        n.className = "mt-4 text-sm opacity-80";
        el.parentElement.insertBefore(n, el);
      } else {
        // ③ どのクエリも無い場合は、ローカル保存分を最後のバックアップとして使う
        var memo = localStorage.getItem("incierge:gpts:intake");
        if (memo) el.value = memo;
      }
    })();
  </script>
</Base>
