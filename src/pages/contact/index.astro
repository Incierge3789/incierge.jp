---
// src/pages/contact/index.astro
import Base from "../../layouts/Base.astro";
const title = "Contact｜INCIERGE";
const desc =
  "ご相談フォーム。GPTでの事前相談メモがあれば自動入力されます。?prefill= もしくは ?gpts= で取り込み。";

// /contact?service=web-analytics のようなクエリを取得
const service = Astro.url.searchParams.get("service") ?? "";
---

<Base title={title} description={desc}>
  <h1 class="text-2xl font-bold mb-6">Contact</h1>

  {/* Decision Gate Message */}
  <section
    class="mb-8 rounded-lg border-2 border-neutral-900 bg-neutral-50 p-6 text-neutral-900"
  >
    <h2 class="mb-4 text-lg font-bold">ご相談について（必ずお読みください）</h2>
    <div class="space-y-4 text-sm leading-relaxed">
      <p>
        この相談は、<br />
        <strong class="font-bold"
          >「自動化の実装に進んでいいかどうか」を確認するためのものです。</strong
        >
      </p>
      <p>
        ツールの紹介や営業、料金の説明は行いません。<br />
        また、「とりあえず楽にしたい」「何ができるか知りたい」<br />
        といった段階でのご相談は対象外としています。
      </p>
      <p>この30分では、</p>
      <ul class="list-disc pl-5 space-y-1">
        <li>業務の前提条件が整理されているか</li>
        <li>判断ルールや例外が構造として成立しているか</li>
        <li>今、実装フェーズに進むべきかどうか</li>
      </ul>
      <p><strong class="font-bold">この一点だけを一緒に確認します。</strong></p>
      <p>
        「進むべきではない」という結論になることもありますが、<br />
        それは失敗を避けるための正しい判断です。
      </p>
    </div>
  </section>

  <p class="mb-4">
    以下のフォームにご記入ください。<br />
    <span class="text-xs text-slate-500"
      >GPTの事前相談メモは <code>?prefill=</code> または <code>?gpts=</code> で自動入力されます。</span
    >
  </p>

  <form method="POST" action="/api/contact" class="mt-6 space-y-4">
    {/* 流入元トラッキング用（/contact?from=...） */}
    <input type="hidden" name="source" id="contact-source" value="" />

    {/* サービス種別（/contact?service=web-analytics など） */}
    <input type="hidden" name="service" value={service} />

    <label class="block">
      <span>お名前（必須）</span>
      <input name="name" required class="w-full border rounded px-3 py-2" />
    </label>

    <label class="block">
      <span>メール（必須）</span>
      <input
        type="email"
        name="email"
        required
        class="w-full border rounded px-3 py-2"
      />
    </label>

    <label class="block">
      <span>会社名（任意）</span>
      <input name="company" class="w-full border rounded px-3 py-2" />
    </label>

    <label class="block">
      <span>HP（任意）</span>
      <input name="website" class="w-full border rounded px-3 py-2" />
    </label>

    <label class="block">
      <span>ご相談内容（必須）</span>
      <textarea
        id="message"
        name="message"
        rows="10"
        required
        class="w-full border rounded px-3 py-2"></textarea>
    </label>

    {/* ▼ 任意：今すぐ日程を予約する（Google カレンダー予約ボタンだけ） */}
    <div class="mt-4 rounded border px-4 py-3 text-sm bg-slate-50">
      <p class="mb-1 text-xs font-semibold text-slate-600">
        任意：今すぐ日程を予約する
      </p>
      <p class="mb-3 leading-relaxed">
        フォーム送信だけでも大丈夫です。すぐに日程まで決めたい方は、
        下のボタンからオンライン面談の候補日時をお選びいただけます。
        （オンライン面談は Google Meet を使用します）
      </p>

      {/* ここに Google カレンダーの予約ボタンが描画される */}
      <div id="gc-appointment-button"></div>
    </div>

    <div class="cf-turnstile" data-sitekey="0x4AAAAAAB9qMJ4SG87lHVc2"></div>

    <button type="submit" class="btn-primary">送信</button>
  </form>

  {/* ▼ カスタマーサポート */}
  <section class="mt-8 text-sm text-slate-700">
    <h2 class="mb-2 text-xs font-semibold text-slate-600">
      カスタマーサポート窓口
    </h2>
    <p class="leading-relaxed">
      お問い合わせ・サポートにつきましては、以下の連絡先でも承っております。<br
      />
      電話：<a href="tel:08063916489" class="underline">080-6391-6489</a><br />
      メール：<a href="mailto:info@incierge.jp" class="underline"
        >info@incierge.jp</a
      >
    </p>
  </section>

  {/* Google カレンダー予約ボタン用の CSS / JS 読み込み */}
  <link
    rel="stylesheet"
    href="https://calendar.google.com/calendar/scheduling-button-script.css"
  />
  <script
    src="https://calendar.google.com/calendar/scheduling-button-script.js"
    async></script>

  <script>
    (function () {
      var params = new URLSearchParams(location.search);

      // ▼ 1) source を hidden にセット
      var source = params.get("from") || "contact_direct";
      var srcInput = document.getElementById("contact-source");
      if (srcInput) srcInput.value = source;

      // ▼ 2) ご相談内容のプリフィル処理
      var el = document.getElementById("message");
      if (el) {
        var gptsRaw = params.get("gpts");
        var prefillRaw = params.get("prefill");
        var qRaw = params.get("q"); // /automation からの一言メモ

        var text = "";

        // 優先順位: gpts > prefill > q
        if (gptsRaw) {
          try {
            text = atob(decodeURIComponent(gptsRaw));
          } catch (e) {
            text = "";
          }
        } else if (prefillRaw) {
          try {
            text = decodeURIComponent(prefillRaw);
          } catch (e) {
            text = "";
          }
        } else if (qRaw) {
          try {
            text = decodeURIComponent(qRaw);
          } catch (e) {
            text = "";
          }
        }

        if (text) {
          el.value = text;
          var n = document.createElement("div");
          n.textContent =
            "AI相談メモ／事前メモを読み込みました。必要に応じて追記・修正してください。";
          n.className = "mt-4 text-sm opacity-80";
          el.parentElement.insertBefore(n, el);
        } else {
          var memo = localStorage.getItem("incierge:gpts:intake");
          if (memo) el.value = memo;
        }
      }

      // ▼ 3) Google カレンダー予約ボタン描画
      window.addEventListener("load", function () {
        var target = document.getElementById("gc-appointment-button");
        if (!target || !window.calendar || !calendar.schedulingButton) return;

        calendar.schedulingButton.load({
          url: "https://calendar.google.com/calendar/appointments/schedules/AcZssZ3vqKZoAQfZQ-e3V3cUSkiPibKprkP2PvSWh7IbUtytQDZh5r4xAFJcIwvW4_evkYncIksqTFP_?gv=true",
          color: "#039BE5",
          label: "オンライン面談の日時を選ぶ",
          target,
        });
      });
    })();
  </script>
</Base>
