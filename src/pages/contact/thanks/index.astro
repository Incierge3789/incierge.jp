---
// src/pages/contact/thanks/index.astro
import Base from "../../../layouts/Base.astro";
const title = "送信完了｜INCIERGE";
---
<Base title={title}>
  <h1>送信ありがとうございました</h1>
  <p>内容を受け付けました。通常、1〜2営業日以内にご連絡いたします。</p>

  <div id="ticketBox" class="mt-4 text-sm opacity-80"></div>

  <script>
    (async () => {
      const box = document.getElementById("ticketBox");
      const p = new URLSearchParams(location.search);
      const t = p.get("ticket");
      if (!t) return;
      box.textContent = "受付番号: " + t;

      // 任意：保存内容の一部を確認表示（必要な場合のみ）
      try {
        const r = await fetch(`/api/contact?ticket=${encodeURIComponent(t)}`);
        if (r.ok) {
          const j = await r.json();
          // ここで必要なら j.summary などを表示
        }
      } catch {}
    })();
  </script>

  <!-- 到達したら1回だけ Goal を送る（確実発火＆二重防止） -->
  <script is:inline>
    (function () {
      // 同タブ内での二重送信防止
      if (sessionStorage.getItem('pl_form_fired')) return;
      sessionStorage.setItem('pl_form_fired', '1');

      var send = function () {
        if (window.plausible) {
          const p = new URLSearchParams(location.search);
          const t = p.get("ticket");
          window.plausible('form_submitted', { props: { has_ticket: t ? 'yes' : 'no', ticket: t || '' }});
        } else {
          // script.js読込前なら100ms後に再試行
          setTimeout(send, 100);
        }
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', send, { once: true });
      } else {
        send();
      }
    })();
  </script>

</Base>
